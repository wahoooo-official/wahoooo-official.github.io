<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Admin Panel</title>

<link rel="icon" type="image/png" href="favicon/favicon.png">

<style>
/* BASE */
body{
  font-family: Trebuchet MS, sans-serif;
  background:#e6e6e6; /* sfondo neutro per test */
  margin:0;
  min-height:100vh;
  overflow-y:auto;
}

.hidden{display:none}

/* HEADER */
header{
  background:#ff9f00;
  color:#fff;
  text-align:center;
  padding:25px;
  font-size:26px;
  font-weight:bold;
  position:sticky;
  top:0;
  z-index:100;
}

/* LOGIN */
.box{
  max-width:420px;
  margin:80px auto;
  background:#fff;
  padding:30px;
  border-radius:14px;
  text-align:center;
  box-shadow:0 0 15px rgba(0,0,0,.2);
}

input,button{
  width:100%;
  padding:12px;
  margin:8px 0;
  border-radius:8px;
  border:1px solid #ccc;
  font-size:15px;
}

button{
  background:#ff9f00;
  color:white;
  font-weight:bold;
  border:none;
  cursor:pointer;
}
button:hover{background:#e08600}

/* ADMIN PANEL */
#adminPanel{
  margin-top:30px;
  padding-bottom:80px;
}

.menu{
  display:flex;
  justify-content:center;
  gap:10px;
  margin:20px;
  flex-wrap:wrap;
}

.container{
  max-width:1100px;
  margin:20px auto;
  background:#fff;
  padding:20px;
  border-radius:14px;
  box-shadow:0 0 15px rgba(0,0,0,.2);
}

/* SECTIONS */
.section{display:none}
.section.active{display:block}

/* FOGLI */
iframe{
  width:100%;
  height:600px;
  border:none;
  border-radius:10px;
}

/* CHAT */
.chat-box{
  height:300px;
  overflow-y:auto;
  background:#f9f9f9;
  padding:10px;
  border-radius:10px;
  border:1px solid #ddd;
}

.msg{
  font-size:14px;
  margin-bottom:6px;
}
.msg strong{color:#ff9f00}

.chat-input{
  display:flex;
  gap:6px;
  margin-top:10px;
}

/* FLOAT CHAT */
#chat-float{
  position:fixed;
  bottom:20px;
  right:20px;
  width:320px;
  background:#fff;
  border-radius:14px;
  box-shadow:0 0 15px rgba(0,0,0,.3);
  display:none;
  flex-direction:column;
  z-index:200;
}

#chat-header{
  background:#ff9f00;
  color:white;
  padding:10px;
  font-weight:bold;
  cursor:pointer;
  border-radius:14px 14px 0 0;
}
</style>
</head>

<body>

<header>ðŸ‘‘ Admin Panel</header>

<!-- LOGIN -->
<div id="loginBox" class="box hidden">
  <h2>Accedi / Registrati</h2>
  <input id="name" placeholder="Nome">
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <button onclick="loginOrRegister()">Accedi / Registrati</button>
  <p id="err" style="color:red"></p>
</div>

<!-- ADMIN -->
<div id="adminPanel" class="hidden">
  <div class="menu">
    <button onclick="show('fogli')">ðŸ“Š Fogli</button>
    <button onclick="show('chat')">ðŸ’¬ Chat</button>
    <button onclick="toggleChat()">ðŸŸ¢ Chat flottante</button>
    <button onclick="logout()">ðŸšª Esci</button>
  </div>

  <div class="container">

    <!-- FOGLI -->
    <div id="fogli" class="section active">
      <iframe
        src="https://docs.google.com/spreadsheets/d/e/2PACX-1vSGKiHRceif9TPzCotNJU-Gt8-gWDn9PoyBiWOplfjbtMXkayJ6hErOSpZJ9YWRMhipLZXS5LXEuZs0/pubhtml">
      </iframe>
    </div>

    <!-- CHAT -->
    <div id="chat" class="section">
      <div id="chatMain" class="chat-box"></div>
      <div class="chat-input">
        <input id="msgMain" placeholder="Messaggio">
        <button onclick="send()">â–¶</button>
      </div>
    </div>

  </div>
</div>

<!-- CHAT FLOAT -->
<div id="chat-float">
  <div id="chat-header" onclick="toggleChat()">ðŸ’¬ Chat</div>
  <div id="chatFloat" class="chat-box"></div>
  <div class="chat-input">
    <input id="msgFloat" placeholder="Messaggio">
    <button onclick="send()">â–¶</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getAuth,
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

import {
  getFirestore,
  collection,
  addDoc,
  query,
  orderBy,
  onSnapshot,
  serverTimestamp,
  doc,
  setDoc,
  getDoc,
  where,
  getDocs,
  deleteDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBHNaMmfMGm-7JQLLagfImQ9L_itv7MBXg",
  authDomain: "wahoooo-adminpannel.firebaseapp.com",
  projectId: "wahoooo-adminpannel",
  storageBucket: "wahoooo-adminpannel.firebasestorage.app",
  messagingSenderId: "720468566572",
  appId: "1:720468566572:web:3c00c076571050d45ce789"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUserName = "Utente";
let currentUID = null;
let unsubscribeChat = null;

/* LOGIN / REGISTER */
window.loginOrRegister = async () => {
  try {
    await signInWithEmailAndPassword(auth, email.value, password.value);
  } catch {
    await createUserWithEmailAndPassword(auth, email.value, password.value);
  }
};

/* AUTH */
onAuthStateChanged(auth, async user => {
  if (user) {
    currentUID = user.uid;

    const userRef = doc(db, "users", user.uid);
    const snap = await getDoc(userRef);

    if (!snap.exists()) {
      currentUserName = name.value || "Utente";
      await setDoc(userRef, { name: currentUserName });
    } else {
      currentUserName = snap.data().name;
    }

    loginBox.classList.add("hidden");
    adminPanel.classList.remove("hidden");
    startChat();
  } else {
    loginBox.classList.remove("hidden");
    adminPanel.classList.add("hidden");
  }
});

/* CHAT */
function startChat(){
  if (unsubscribeChat) return;

  const q = query(collection(db,"chat"), orderBy("time"));
  unsubscribeChat = onSnapshot(q, snap=>{
    chatMain.innerHTML="";
    chatFloat.innerHTML="";
    snap.forEach(d=>{
      const m=d.data();
      const html=`<div class="msg"><strong>${m.user}:</strong> ${m.text}</div>`;
      chatMain.innerHTML+=html;
      chatFloat.innerHTML+=html;
    });
  });
}

/* SEND */
window.send = async ()=>{
  const text = msgMain.value || msgFloat.value;
  if(!text) return;

  await addDoc(collection(db,"chat"),{
    uid:currentUID,
    user:currentUserName,
    text,
    time:serverTimestamp()
  });

  msgMain.value="";
  msgFloat.value="";
};

/* UI */
window.show = id=>{
  document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
};

window.toggleChat = ()=>{
  chatFloat.style.display =
    chatFloat.style.display==="flex" ? "none" : "flex";
};

window.logout = async ()=>{
  await signOut(auth);
  location.reload();
};
</script>

</body>
</html>
